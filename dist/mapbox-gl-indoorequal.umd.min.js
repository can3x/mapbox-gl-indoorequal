!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).IndoorEqual=t()}(this,(function(){"use strict";function e(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function t(t){for(var i=1;i<arguments.length;i++){var n=null!=arguments[i]?arguments[i]:{};i%2?e(Object(n),!0).forEach((function(e){a(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):e(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function r(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function a(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function o(e,t){if(null==e)return{};var i,n,r=function(e,t){if(null==e)return{};var i,n,r={},a=Object.keys(e);for(n=0;n<a.length;n++)i=a[n],t.indexOf(i)>=0||(r[i]=e[i]);return r}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(n=0;n<a.length;n++)i=a[n],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(r[i]=e[i])}return r}function s(e){return function(e){if(Array.isArray(e))return l(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return l(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);"Object"===i&&e.constructor&&(i=e.constructor.name);if("Map"===i||"Set"===i)return Array.from(e);if("Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return l(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function c(e,t,i){var n,r,a,o,s;function l(){var c=Date.now()-o;c<t&&c>=0?n=setTimeout(l,t-c):(n=null,i||(s=e.apply(a,r),a=r=null))}null==t&&(t=100);var c=function(){a=this,r=arguments,o=Date.now();var c=i&&!n;return n||(n=setTimeout(l,t)),c&&(s=e.apply(a,r),a=r=null),s};return c.clear=function(){n&&(clearTimeout(n),n=null)},c.flush=function(){n&&(s=e.apply(a,r),a=r=null,clearTimeout(n),n=null)},c}c.debounce=c;var u=c;var h=function(){function e(t){var n=this;i(this,e),this.indoorequal=t,this._cbRefresh=function(){return n._refresh()},this.indoorequal.on("levelschange",this._cbRefresh),this.indoorequal.on("levelchange",this._cbRefresh),this.$el=document.createElement("div"),this.$el.classList.add("mapboxgl-ctrl","mapboxgl-ctrl-group","mapboxgl-ctrl-indoorequal"),this._refresh()}return r(e,[{key:"destroy",value:function(){this.$el.remove(),this.indoorequal.off("levelschange",this._cbRefresh),this.indoorequal.off("levelchange",this._cbRefresh)}},{key:"_refresh",value:function(){var e=this;this.$el.innerHTML="",this.indoorequal.levels.forEach((function(t){var i=document.createElement("button"),n=document.createElement("strong");n.textContent=t,i.appendChild(n),t==e.indoorequal.level&&i.classList.add("mapboxgl-ctrl-active"),i.addEventListener("click",(function(){e.indoorequal.setLevel(t)})),e.$el.appendChild(i)}))}}]),e}(),f={type:"symbol","source-layer":"poi",layout:{"icon-image":["coalesce",["image",["concat",["literal","indoorequal-"],["get","subclass"]]],["image",["concat",["literal","indoorequal-"],["get","class"]]]],"text-anchor":"top","text-field":["concat",["get","name:latin"],"\n",["get","name:nonlatin"]],"text-max-width":9,"text-offset":[0,.6],"text-padding":2,"text-size":12},paint:{"text-color":"#666","text-halo-blur":.5,"text-halo-color":"#ffffff","text-halo-width":1}},d=["waste_basket","information","vending_machine","bench","photo_booth","ticket_validator"],p=[{id:"indoor-polygon",type:"fill","source-layer":"area",filter:["all",["==","$type","Polygon"],["!=","class","level"]],paint:{"fill-color":["case",["all",["has","access"],["in",["get","access"],["literal",["no","private"]]]],"#F2F1F0",["any",["all",["==",["get","is_poi"],!0],["!=",["get","class"],"corridor"]],["in",["get","subclass"],["literal",["class","laboratory","office","auditorium","amphitheatre","reception"]]]],"#D4EDFF",["==",["get","class"],"room"],"#fefee2","#fdfcfa"]}},{id:"indoor-area",type:"line","source-layer":"area",filter:["all",["in","class","area","corridor","platform"]],paint:{"line-color":"#bfbfbf","line-width":1}},{id:"indoor-column",type:"fill","source-layer":"area",filter:["all",["==","class","column"]],paint:{"fill-color":"#bfbfbf"}},{id:"indoor-lines",type:"line","source-layer":"area",filter:["all",["in","class","room","wall"]],paint:{"line-color":"gray","line-width":2}},{id:"indoor-transportation",type:"line","source-layer":"transportation",filter:["all"],paint:{"line-color":"gray","line-dasharray":[.4,.75],"line-width":{base:1.4,stops:[[17,2],[20,10]]}}},{id:"indoor-transportation-poi",type:"symbol","source-layer":"transportation",filter:["all",["in","$type","Point","LineString"],["in","class","steps","elevator","escalator"]],layout:{"icon-image":["case",["has","conveying"],"indoorequal-escalator",["concat",["literal","indoorequal-"],["get","class"]]],"symbol-placement":"line-center","icon-rotation-alignment":"viewport"}},t(t({id:"indoor-poi-rank1"},f),{},{filter:["all",["==","$type","Point"],["!in","class"].concat(d)]}),t(t({id:"indoor-poi-rank2"},f),{},{minzoom:19,filter:["all",["==","$type","Point"],["in","class"].concat(d)]}),{id:"indoor-heat",type:"heatmap","source-layer":"heat",filter:["all"],paint:{"heatmap-color":["interpolate",["linear"],["heatmap-density"],0,"rgba(102, 103, 173, 0)",.1,"rgba(102, 103, 173, 0.2)",1,"rgba(102, 103, 173, 0.7)"],"heatmap-radius":["interpolate",["linear"],["zoom"],0,3,13,20,17,40],"heatmap-intensity":1,"heatmap-opacity":["interpolate",["linear"],["zoom"],16,1,17.1,0]}},{id:"indoor-name",type:"symbol","source-layer":"area_name",filter:["all"],layout:{"text-field":["concat",["coalesce",["get","name:latin"],["get","ref"]],"\n",["get","name:nonlatin"]],"text-max-width":5,"text-size":14},paint:{"text-color":"#666","text-halo-color":"#ffffff","text-halo-width":1}}];function v(e,t,i,n){var r=t.width,a=t.height;if(n){if(n instanceof Uint8ClampedArray)n=new Uint8Array(n.buffer);else if(n.length!==r*a*i)throw new RangeError("mismatched image size")}else n=new Uint8Array(r*a*i);return e.width=r,e.height=a,e.data=n,e}function y(e,t,i,n,r,a){if(0===r.width||0===r.height)return t;if(r.width>e.width||r.height>e.height||i.x>e.width-r.width||i.y>e.height-r.height)throw new RangeError("out of range source coordinates for image copy");if(r.width>t.width||r.height>t.height||n.x>t.width-r.width||n.y>t.height-r.height)throw new RangeError("out of range destination coordinates for image copy");for(var o=e.data,s=t.data,l=0;l<r.height;l++)for(var c=((i.y+l)*e.width+i.x)*a,u=((n.y+l)*t.width+n.x)*a,h=0;h<r.width*a;h++)s[u+h]=o[c+h];return t}var m=function(){function e(t,n){i(this,e),v(this,t,4,n)}return r(e,[{key:"resize",value:function(e){!function(e,t,i){var n=t.width,r=t.height;if(n!==e.width||r!==e.height){var a=v({},{width:n,height:r},i);y(e,a,{x:0,y:0},{x:0,y:0},{width:Math.min(e.width,n),height:Math.min(e.height,r)},i),e.width=n,e.height=r,e.data=a.data}}(this,e,4)}},{key:"replace",value:function(e,t){t?this.data.set(e):e instanceof Uint8ClampedArray?this.data=new Uint8Array(e.buffer):this.data=e}},{key:"clone",value:function(){return new e({width:this.width,height:this.height},new Uint8Array(this.data))}}],[{key:"copy",value:function(e,t,i,n,r){y(e,t,i,n,r,4)}}]),e}();function g(e){var t,i,n=window.devicePixelRatio>1?"@2x":"",r=fetch("".concat(e).concat(n,".json")).then((function(e){return e.json()})).then((function(e){return t=e})),a=fetch("".concat(e).concat(n,".png")).then((function(e){return e.blob()})).then((function(e){return(i=new Image).src=URL.createObjectURL(e),new Promise((function(e,t){i.onload=function(){return e()},i.onerror=function(){return t()}}))}));return Promise.all([r,a]).then((function(){var e=function(e,t){var i=window.document.createElement("canvas"),n=i.getContext("2d");if(!n)throw new Error("failed to create canvas 2d context");return i.width=e.width,i.height=e.height,n.drawImage(e,0,0,e.width,e.height),n.getImageData(0,0,e.width,e.height)}(i),n={};for(var r in t){var a=t[r],o=a.width,s=a.height,l=a.x,c=a.y,u=a.sdf,h=a.pixelRatio,f=a.stretchX,d=a.stretchY,p=a.content,v=new m({width:o,height:s});m.copy(e,v,{x:l,y:c},{x:0,y:0},{width:o,height:s}),n[r]={data:v,pixelRatio:h,sdf:u,stretchX:f,stretchY:d,content:p}}return n}))}var b=["data"],w=function(){function e(n){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,e);var a={layers:p,geojson:{}},o=t(t({},a),r);this.map=n,this.geojson=o.geojson,this.layers=o.layers,this.baseSourceId="indoorequal",this.sourceId="".concat(this.baseSourceId,"_area")}return r(e,[{key:"addSource",value:function(){var e=this;Object.keys(this.geojson).forEach((function(t){e.map.addSource("".concat(e.baseSourceId,"_").concat(t),{type:"geojson",data:e.geojson[t]})}))}},{key:"addLayers",value:function(){var e=this,i=Object.keys(this.geojson),n=this.layers;this.layers=n.filter((function(e){return i.includes(e["source-layer"])})),this.layers.forEach((function(i){e.map.addLayer(t(t({source:"".concat(e.baseSourceId,"_").concat(i["source-layer"])},i),{},{"source-layer":""}))}))}},{key:"remove",value:function(){var e=this;this.layers.forEach((function(t){e.map.removeLayer(t.id)})),Object.keys(this.geojson).forEach((function(t){e.map.removeSource("".concat(e.baseSourceId,"_").concat(t))}))}}]),e}(),x=function(){function e(n){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,e);var a={url:"https://tiles.indoorequal.org/",layers:p},o=t(t({},a),r);if(o.url===a.url&&!o.apiKey)throw"You must register your apiKey at https://indoorequal.com before and set it as apiKey param.";this.map=n,this.url=o.url,this.apiKey=o.apiKey,this.layers=o.layers,this.sourceId="indoorequal"}return r(e,[{key:"addSource",value:function(){var e=this.apiKey?"?key=".concat(this.apiKey):"";this.map.addSource(this.sourceId,{type:"vector",tiles:["".concat(this.url).concat(e)]})}},{key:"addLayers",value:function(){var e=this;this.layers.forEach((function(i){e.map.addLayer(t({source:e.sourceId},i))}))}},{key:"remove",value:function(){var e=this;this.layers.forEach((function(t){e.map.removeLayer(t.id)})),this.map.removeSource(this.sourceId)}}]),e}(),_=function(){function e(n){var r=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};i(this,e);var o=a.geojson?w:x,s={heatmap:!0},l=t(t({},s),a);this.source=new o(n,a),this.sourceAux=null,this.map=n,this.levels=[],this.level="0",this.events={},this.map.isStyleLoaded()?(this._init(),this.setHeatmapVisible(l.heatmap)):this.map.once("load",(function(){r._init(),r.setHeatmapVisible(l.heatmap)}))}return r(e,[{key:"remove",value:function(){this.source.remove(),this.sourceAux&&this.sourceAux.remove(),this._updateLevelsDebounce.clear(),this.map.off("load",this._updateLevelsDebounce),this.map.off("data",this._updateLevelsDebounce),this.map.off("move",this._updateLevelsDebounce),this._control&&this.onRemove()}},{key:"on",value:function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}},{key:"off",value:function(e,t){this.events[e]||(this.events[e]=[]),this.events[e]=this.events[e].filter((function(e){return e!==t}))}},{key:"onAdd",value:function(){return this._control=new h(this),this._control.$el}},{key:"onRemove",value:function(){this._control.destroy(),this._control=null}},{key:"setLevel",value:function(e){this.level=e,this._updateFilters(),this._emitLevelChange()}},{key:"updateLevel",value:function(e){console.log("The updateLevel method is deprecated. Please use setLevel instead."),this.setLevel(e)}},{key:"loadSprite",value:function(e){var i=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t({update:!1},n);return g(e).then((function(e){for(var t in e){var n=e[t],a=n.data,s=o(n,b);i.map.hasImage(t)?r.update&&i.map.updateImage(t,a):i.map.addImage(t,a,s)}return e}))}},{key:"setAuxSource",value:function(e){this.sourceAux&&this.sourceAux.remove(),this.sourceAux=new w(this.map,e),this.sourceAux.addSource(),this.sourceAux.addLayers(),this._updateFilters()}},{key:"setHeatmapVisible",value:function(e){this.map.getLayer("indoor-heat")&&this.map.setLayoutProperty("indoor-heat","visibility",e?"visible":"none")}},{key:"_init",value:function(){var e=this;this.source.addSource(),this.source.addLayers(),this._updateFilters(),this._updateLevelsDebounce=u(this._updateLevels.bind(this),1e3),this.map.on("load",this._updateLevelsDebounce),this.map.on("data",this._updateLevelsDebounce),this.map.on("move",this._updateLevelsDebounce),this.map.on("remove",(function(){e.remove()}))}},{key:"_updateFilters",value:function(){var e=this;this.source.layers.filter((function(e){return"heatmap"!==e.type})).forEach((function(t){e.map.setFilter(t.id,[].concat(s(t.filter||["all"]),[["==","level",e.level]]))})),this.sourceAux&&this.sourceAux.layers.filter((function(e){return"heatmap"!==e.type})).forEach((function(t){e.map.setFilter(t.id,[].concat(s(t.filter||["all"]),[["==","level",e.level]]))}))}},{key:"_refreshAfterLevelsUpdate",value:function(){this.levels.includes(this.level)||this.setLevel("0")}},{key:"_updateLevels",value:function(){if(this.map.isSourceLoaded(this.source.sourceId)){var e=function(e){for(var t=[],i=0;i<e.length;i++){var n=e[i];if("level"!==n.properties.class){var r=n.properties.level;t.includes(r)||t.push(r)}}return t.sort((function(e,t){return e-t})).reverse()}(this.map.querySourceFeatures(this.source.sourceId,{sourceLayer:"area"}));(function(e,t){var i=e.length;if(i!==t.length)return!1;for(var n=0;n<i;n++)if(e[n]!==t[n])return!1;return!0})(e,this.levels)||(this.levels=e,this._emitLevelsChange(),this._refreshAfterLevelsUpdate())}}},{key:"_emitLevelsChange",value:function(){this._emitEvent("levelschange",this.levels)}},{key:"_emitLevelChange",value:function(){this._emitEvent("levelchange",this.level)}},{key:"_emitEvent",value:function(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];(this.events[e]||[]).forEach((function(e){return e.apply(void 0,i)}))}}]),e}();return _}));
