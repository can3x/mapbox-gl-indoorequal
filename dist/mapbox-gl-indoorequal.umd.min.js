!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).IndoorEqual=t()}(this,(function(){"use strict";function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function n(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function a(e,t){if(null==e)return{};var n,i,r=function(e,t){if(null==e)return{};var n,i,r={},o=Object.keys(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}function l(e){return function(e){if(Array.isArray(e))return s(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return s(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return s(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function c(e,t,n){var i,r,o,a,l;function s(){var c=Date.now()-a;c<t&&c>=0?i=setTimeout(s,t-c):(i=null,n||(l=e.apply(o,r),o=r=null))}null==t&&(t=100);var c=function(){o=this,r=arguments,a=Date.now();var c=n&&!i;return i||(i=setTimeout(s,t)),c&&(l=e.apply(o,r),o=r=null),l};return c.clear=function(){i&&(clearTimeout(i),i=null)},c.flush=function(){i&&(l=e.apply(o,r),o=r=null,clearTimeout(i),i=null)},c}c.debounce=c;var h=c;var u=function(){function t(n){var i=this;e(this,t),this.indoorequal=n,this._cbRefresh=function(){return i._refresh()},this.indoorequal.on("levelschange",this._cbRefresh),this.indoorequal.on("levelchange",this._cbRefresh),this.$el=document.createElement("div"),this.$el.classList.add("mapboxgl-ctrl","mapboxgl-ctrl-group","mapboxgl-ctrl-indoorequal"),this._refresh()}return n(t,[{key:"destroy",value:function(){this.$el.remove(),this.indoorequal.off("levelschange",this._cbRefresh),this.indoorequal.off("levelchange",this._cbRefresh)}},{key:"_refresh",value:function(){var e=this;if(this.$el.innerHTML="",1!==this.indoorequal.levels.length)this.indoorequal.levels.map((function(t){var n=document.createElement("button"),i=document.createElement("strong");i.textContent=t,n.appendChild(i),t==e.indoorequal.level&&n.classList.add("mapboxgl-ctrl-active"),n.addEventListener("click",(function(){e.indoorequal.setLevel(t)})),e.$el.appendChild(n)}))}}]),t}(),f={type:"symbol","source-layer":"poi",layout:{"icon-image":["coalesce",["image",["concat",["literal","indoorequal-"],["get","subclass"]]],["image",["concat",["literal","indoorequal-"],["get","class"]]]],"text-anchor":"top","text-field":"{name:latin}\n{name:nonlatin}","text-max-width":9,"text-offset":[0,.6],"text-padding":2,"text-size":12},paint:{"text-color":"#666","text-halo-blur":.5,"text-halo-color":"#ffffff","text-halo-width":1}},d=["waste_basket","information","vending_machine"],p=[{id:"indoor-polygon",type:"fill","source-layer":"area",filter:["all",["==","$type","Polygon"],["!=","class","level"]],paint:{"fill-color":["case",["all",["has","access"],["in",["get","access"],["literal",["no","private"]]]],"#F2F1F0",["all",["==",["get","is_poi"],!0],["!=",["get","class"],"corridor"]],"#D4EDFF",["==",["get","class"],"room"],"#fefee2","#fdfcfa"]}},{id:"indoor-area",type:"line","source-layer":"area",filter:["all",["in","class","area","corridor","platform"]],paint:{"line-color":"#bfbfbf","line-width":1}},{id:"indoor-column",type:"fill","source-layer":"area",filter:["all",["==","class","column"]],paint:{"fill-color":"#bfbfbf"}},{id:"indoor-lines",type:"line","source-layer":"area",filter:["all",["in","class","room","wall"]],paint:{"line-color":"gray","line-width":2}},{id:"indoor-transportation",type:"line","source-layer":"transportation",filter:["all"],paint:{"line-color":"gray","line-dasharray":[.4,.75],"line-width":{base:1.4,stops:[[17,2],[20,10]]}}},{id:"indoor-transportation-poi",type:"symbol","source-layer":"transportation",filter:["all",["in","$type","Point","LineString"],["in","class","steps","elevator","escalator"]],layout:{"icon-image":["case",["has","conveying"],"indoorequal-escalator",["concat",["literal","indoorequal-"],["get","class"]]],"symbol-placement":"line-center","icon-rotation-alignment":"viewport"}},o(o({id:"indoor-poi-rank1"},f),{},{filter:["all",["==","$type","Point"],["!in","class"].concat(d)]}),o(o({id:"indoor-poi-rank2"},f),{},{minzoom:19,filter:["all",["==","$type","Point"],["in","class"].concat(d)]}),{id:"indoor-name",type:"symbol","source-layer":"area_name",filter:["all"],layout:{"text-field":["get","name"],"text-max-width":5,"text-size":14},paint:{"text-color":"#666","text-halo-color":"#ffffff","text-halo-width":1}}];function y(e,t,n,i){var r=t.width,o=t.height;if(i){if(i instanceof Uint8ClampedArray)i=new Uint8Array(i.buffer);else if(i.length!==r*o*n)throw new RangeError("mismatched image size")}else i=new Uint8Array(r*o*n);return e.width=r,e.height=o,e.data=i,e}function v(e,t,n,i,r,o){if(0===r.width||0===r.height)return t;if(r.width>e.width||r.height>e.height||n.x>e.width-r.width||n.y>e.height-r.height)throw new RangeError("out of range source coordinates for image copy");if(r.width>t.width||r.height>t.height||i.x>t.width-r.width||i.y>t.height-r.height)throw new RangeError("out of range destination coordinates for image copy");for(var a=e.data,l=t.data,s=0;s<r.height;s++)for(var c=((n.y+s)*e.width+n.x)*o,h=((i.y+s)*t.width+i.x)*o,u=0;u<r.width*o;u++)l[h+u]=a[c+u];return t}var g=function(){function t(n,i){e(this,t),y(this,n,4,i)}return n(t,[{key:"resize",value:function(e){!function(e,t,n){var i=t.width,r=t.height;if(i!==e.width||r!==e.height){var o=y({},{width:i,height:r},n);v(e,o,{x:0,y:0},{x:0,y:0},{width:Math.min(e.width,i),height:Math.min(e.height,r)},n),e.width=i,e.height=r,e.data=o.data}}(this,e,4)}},{key:"replace",value:function(e,t){t?this.data.set(e):e instanceof Uint8ClampedArray?this.data=new Uint8Array(e.buffer):this.data=e}},{key:"clone",value:function(){return new t({width:this.width,height:this.height},new Uint8Array(this.data))}}],[{key:"copy",value:function(e,t,n,i,r){v(e,t,n,i,r,4)}}]),t}();function m(e){var t,n,i=window.devicePixelRatio>1?"@2x":"",r=fetch("".concat(e).concat(i,".json")).then((function(e){return e.json()})).then((function(e){return t=e})),o=fetch("".concat(e).concat(i,".png")).then((function(e){return e.blob()})).then((function(e){return(n=new Image).src=URL.createObjectURL(e),new Promise((function(e,t){n.onload=function(){return e()},n.onerror=function(){return t()}}))}));return Promise.all([r,o]).then((function(){var e=function(e,t){var n=window.document.createElement("canvas"),i=n.getContext("2d");if(!i)throw new Error("failed to create canvas 2d context");return n.width=e.width,n.height=e.height,i.drawImage(e,0,0,e.width,e.height),i.getImageData(0,0,e.width,e.height)}(n),i={};for(var r in t){var o=t[r],a=o.width,l=o.height,s=o.x,c=o.y,h=o.sdf,u=o.pixelRatio,f=o.stretchX,d=o.stretchY,p=o.content,y=new g({width:a,height:l});g.copy(e,y,{x:s,y:c},{x:0,y:0},{width:a,height:l}),i[r]={data:y,pixelRatio:u,sdf:h,stretchX:f,stretchY:d,content:p}}return i}))}return function(){function t(n){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e(this,t);var r={url:"https://tiles.indoorequal.org/",layers:p},a=o(o({},r),i);if(a.url===r.url&&!a.apiKey)throw"You must register your apiKey at https://indoorequal.com before and set it as apiKey param.";this.map=n,this.url=a.url,this.apiKey=a.apiKey,this.layers=a.layers,this.levels=[],this.level="0",this.events={},this.map.isStyleLoaded()?this._addSource():this.map.on("load",this._addSource.bind(this))}return n(t,[{key:"on",value:function(e,t){this.events[e]||(this.events[e]=[]),this.events[e].push(t)}},{key:"off",value:function(e,t){this.events[e]||(this.events[e]=[]),this.events[e]=this.events[e].filter((function(e){return e!==t}))}},{key:"onAdd",value:function(){return this._control=new u(this),this._control.$el}},{key:"onRemove",value:function(){this._control.destroy(),this._control=null}},{key:"setLevel",value:function(e){this.level=e,this._updateFilters(),this._emitLevelChange()}},{key:"updateLevel",value:function(e){console.log("The updateLevel method is deprecated. Please use setLevel instead."),this.setLevel(e)}},{key:"loadSprite",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=o({update:!1},n);return m(e).then((function(e){for(var n in e){var r=e[n],o=r.data,l=a(r,["data"]);t.map.hasImage(n)?i.update&&t.map.updateImage(n,o):t.map.addImage(n,o,l)}return e}))}},{key:"_addSource",value:function(){var e=this,t=this.apiKey?"?key=".concat(this.apiKey):"";this.map.addSource("indoorequal",{type:"vector",url:"".concat(this.url).concat(t)}),this.layers.forEach((function(t){e.map.addLayer(o({source:"indoorequal"},t))})),this._updateFilters();var n=h(this._updateLevels.bind(this),1e3);this.map.on("load",n),this.map.on("data",n),this.map.on("move",n)}},{key:"_updateFilters",value:function(){var e=this;this.layers.forEach((function(t){e.map.setFilter(t.id,[].concat(l(t.filter||["all"]),[["==","level",e.level]]))}))}},{key:"_refreshAfterLevelsUpdate",value:function(){this.levels.includes(this.level)||this.setLevel("0")}},{key:"_updateLevels",value:function(){if(this.map.isSourceLoaded("indoorequal")){var e=function(e){for(var t=[],n=0;n<e.length;n++){var i=e[n].properties.level;t.includes(i)||t.push(i)}return t.sort((function(e,t){return e-t})).reverse()}(this.map.querySourceFeatures("indoorequal",{sourceLayer:"area"}));(function(e,t){var n=e.length;if(n!==t.length)return!1;for(var i=0;i<n;i++)if(e[i]!==t[i])return!1;return!0})(e,this.levels)||(this.levels=e,this._emitLevelsChange(),this._refreshAfterLevelsUpdate())}}},{key:"_emitLevelsChange",value:function(){this._emitEvent("levelschange",this.levels)}},{key:"_emitLevelChange",value:function(){this._emitEvent("levelchange",this.level)}},{key:"_emitEvent",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];(this.events[e]||[]).forEach((function(e){return e.apply(void 0,n)}))}}]),t}()}));
